<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚¯ãƒ‡ãƒŠã‚· Tunes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg: #f5f3ff; --header-text: #7c3aed; --card-bg: #ffffff;
            --text: #2d3748; --accent: #3b82f6; 
            --type-tag: #ec4899; --button-active: #6366f1; --border: #c4b5fd;
            --fav: #cbd5e1;
        }
        body.dark {
            --bg: #0f172a; --header-text: #a78bfa; --card-bg: #1e293b;
            --text: #f1f5f9; --accent: #60a5fa; --border: #334155;
        }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; transition: 0.3s; }
        
        .theme-switch {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: var(--card-bg); border: 2px solid var(--border);
            width: 45px; height: 45px; border-radius: 50%; cursor: pointer;
            color: var(--header-text); box-shadow: 4px 4px 0px var(--border);
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }

        header h1 {
            text-align: center; padding: 60px 20px 20px; font-weight: 900; font-size: clamp(2rem, 8vw, 3.5rem); margin: 0;
            background: linear-gradient(135deg, var(--accent), var(--header-text));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            transform: rotate(-2deg); filter: drop-shadow(4px 4px 0px var(--border));
        }

        .container { max-width: 800px; margin: 0 auto 100px; padding: 0 20px; }

        /* --- ã€æ–°è¨­ã€‘ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒ --- */
        .tab-switcher {
            display: flex; justify-content: center; gap: 15px; margin-bottom: 30px;
        }
        .tab-btn {
            background: var(--card-bg); border: 3px solid var(--border); padding: 12px 25px;
            border-radius: 20px; font-weight: 900; cursor: pointer; color: var(--header-text);
            box-shadow: 5px 5px 0px var(--border); transition: 0.2s; font-size: 1rem;
            display: flex; align-items: center; gap: 8px;
        }
        .tab-btn.active {
            background: var(--button-active); color: white; border-color: var(--button-active);
            transform: translate(2px, 2px); box-shadow: 2px 2px 0px var(--border);
        }

        /* --- æ²ç¤ºæ¿ã‚³ãƒ¼ãƒŠãƒ¼å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .board-view {
            background: var(--card-bg); padding: 30px; border-radius: 30px;
            border: 3px solid var(--border); box-shadow: 10px 10px 0px var(--border);
        }
        .board-item {
            background: var(--bg); padding: 20px; border-radius: 20px;
            border: 2px solid var(--border); margin-bottom: 15px; cursor: pointer;
            transition: 0.3s;
        }
        .board-item:hover { transform: scale(1.02); }
        .board-item b { color: var(--header-text); font-size: 1.1rem; }
        .board-item .target-song { font-size: 0.8rem; background: var(--accent); color: white; padding: 3px 10px; border-radius: 10px; margin-left: 10px; }

        /* --- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ --- */
        .filter-section {
            background: var(--card-bg); padding: 25px; border-radius: 25px;
            border: 3px solid var(--border); box-shadow: 8px 8px 0px var(--border); margin-bottom: 40px;
        }
        #search-box {
            width: 100%; padding: 12px 20px; border: 2px solid var(--border); border-radius: 15px;
            font-size: 1rem; outline: none; margin-bottom: 15px; box-sizing: border-box; font-weight: bold; background: var(--card-bg); color: var(--text);
        }

        .sort-select {
            width: 100%; padding: 10px 15px; border: 2px solid var(--border); border-radius: 12px;
            background: var(--card-bg); color: var(--text); font-weight: 800; cursor: pointer; margin-bottom: 15px; outline: none;
        }

        .toggle-filter-btn {
            background: none; border: none; color: var(--header-text); font-weight: 900;
            cursor: pointer; display: flex; align-items: center; gap: 8px; margin: 0 auto 10px;
        }

        .filter-container { max-height: 2000px; overflow: hidden; transition: 0.5s ease; opacity: 1; }
        .filter-container.collapsed { max-height: 0; opacity: 0; margin-bottom: 0; }
        .filter-group { margin-bottom: 20px; }
        .filter-label { display: block; font-size: 0.9rem; font-weight: 900; color: var(--header-text); margin-bottom: 10px; }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .tag-btn-filter {
            background: var(--card-bg); border: 2px solid var(--border); padding: 8px 18px; border-radius: 50px;
            font-size: 0.85rem; cursor: pointer; transition: 0.2s; font-weight: 800; color: var(--text);
        }
        .tag-btn-filter.active { background: var(--button-active); color: white; border-color: var(--button-active); }

        .song-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
        .song-card {
            background: var(--card-bg); padding: 25px; border-radius: 25px; border: 2px solid var(--border);
            transition: 0.3s; cursor: pointer; box-shadow: 5px 5px 0px var(--border); display: flex; flex-direction: column; gap: 10px; position: relative;
        }
        .song-card b { font-size: 1.2rem; color: var(--header-text); padding-right: 30px; }

        .fav-btn {
            position: absolute; top: 20px; right: 20px; background: none; border: none;
            font-size: 1.3rem; cursor: pointer; color: var(--fav); transition: 0.2s; z-index: 5;
        }
        .fav-btn.active { color: #ef4444; animation: heartBeat 0.3s ease; }
        @keyframes heartBeat { 0% {transform: scale(1);} 50% {transform: scale(1.3);} 100% {transform: scale(1);} }

        .card-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: auto; }
        .mini-tag { font-size: 0.65rem; font-weight: 800; padding: 4px 10px; border-radius: 8px; color: white; background: var(--accent); display: inline-flex; align-items: center; gap: 4px; }
        .mini-tag.y { background: var(--type-tag); }
        .date-badge { font-size: 0.7rem; font-weight: 700; opacity: 0.6; }

        .hidden { display: none !important; }
        .detail-view { background: var(--card-bg); padding: 40px; border-radius: 35px; border: 4px solid var(--border); box-shadow: 15px 15px 0px var(--header-text); }
        .yt-link { text-decoration:none; color:white; background:#ff0000; padding:15px 25px; border-radius:50px; font-weight:900; display:inline-flex; align-items:center; gap:10px; }
        
        .full-btn { background: #ffd700; color: #000; padding: 15px 25px; border-radius: 50px; font-weight: 900; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; box-shadow: 4px 4px 0px #000; }
        
        #comment-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 9999; flex-direction: column; padding: 20px; box-sizing: border-box;
        }
        #comment-overlay.active { display: flex; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* 1. ã€ä¿®æ­£ã€‘å…¨ç”»é¢æ™‚ã®ä¸‹ã®å…¥åŠ›æ¬„ãƒã‚°ã‚’è§£æ±º */
    .fs-post-area {
        background: var(--card-bg);
        padding: 15px;
        border-radius: 20px;
        border: 2px solid var(--border);
        display: flex;
        gap: 8px;
        margin-top: auto; /* ä¸‹ç«¯ã«å›ºå®šã—ã‚„ã™ãã™ã‚‹ */
        box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
        box-sizing: border-box;
        width: 100%;
    }

    .fs-post-area input {
        min-width: 0; /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹å†…ã§ã®å´©ã‚Œé˜²æ­¢ */
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-weight: bold;
        background: var(--bg);
        color: var(--text);
        box-sizing: border-box;
    }

    /* ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ æ¬„ï¼ˆå°‘ã—ç‹­ãï¼‰ */
    #nickname-fs {
        flex: 1;
    }

    /* æ„Ÿæƒ³æ¬„ï¼ˆåºƒãï¼‰ */
    #comment-text-fs {
        flex: 2;
    }

    /* é€ä¿¡ãƒœã‚¿ãƒ³ */
    .fs-post-area button {
        background: var(--header-text);
        color: white;
        border: none;
        padding: 0 15px;
        border-radius: 12px;
        font-weight: 900;
        cursor: pointer;
        white-space: nowrap; /* ãƒœã‚¿ãƒ³æ–‡å­—ã®æ”¹è¡Œé˜²æ­¢ */
    }

    /* 2. ã€ä¿®æ­£ã€‘ã‚¹ãƒ¬ãƒƒãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®éš ã—è¨­å®š */
    #thread-overlay {
        display: none; /* æ™®æ®µã¯éš ã™ */
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%;
        background: var(--bg); 
        z-index: 10005; /* æ„Ÿæƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚ˆã‚Šã•ã‚‰ã«æ‰‹å‰ã¸ */
        flex-direction: column; 
        padding: 20px; 
        box-sizing: border-box;
    }

    /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã ã‘è¡¨ç¤º */
    #thread-overlay.active { 
        display: flex; 
        animation: slideUp 0.3s ease-out; 
    }

    /* ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®è£…é£¾ */
    #thread-parent-root .comment-item {
        border-left: 5px solid var(--accent) !important;
        box-shadow: 5px 5px 0px var(--border);
    }
    .reply-item {
        margin-left: 20px;
        position: relative;
    }
    .reply-item::before {
        content: "â¤·";
        position: absolute;
        left: -18px;
        top: 10px;
        color: var(--accent);
        font-weight: 900;
    }


    </style>
</head>
<body class="light">

<button class="theme-switch" onclick="toggleTheme()"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
<header><h1>ãƒ­ã‚¯ãƒ‡ãƒŠã‚· Tunes</h1></header>

<div class="container">
    <div class="tab-switcher">
        <button id="btn-songs" class="tab-btn active" onclick="switchTab('songs')"><i class="fa-solid fa-music"></i> æ¥½æ›²ä¸€è¦§</button>
        <button id="btn-board" class="tab-btn" onclick="switchTab('board')"><i class="fa-solid fa-comments"></i> æ²ç¤ºæ¿</button>
    </div>
<div id="result-count" style="margin: 10px 0; font-size: 0.9rem; font-weight: 900; color: var(--header-text); opacity: 0.8;">
    </div>


    <div id="tab-content-songs">
        <div class="filter-section">
            <input type="text" id="search-box" placeholder="æ›²åã‚’ã•ãŒã™ï¼" onkeyup="search()">
            <select id="sort-order" class="sort-select" onchange="search()">
                <option value="date-desc">âœ¨ æ–°ã—ã„é †</option>
                <option value="date-asc">â³ å¤ã„é †</option>
                <option value="kana-asc">ğŸ”¤ äº”åéŸ³é †</option>
            </select>
            <button class="toggle-filter-btn" onclick="toggleFilter()"><i id="filter-icon" class="fa-solid fa-chevron-up"></i> çµã‚Šè¾¼ã¿</button>
            <div id="filter-content" class="filter-container"></div>
        </div>
        <div id="song-list" class="song-grid"></div>
    </div>

    <div id="tab-content-board" class="hidden">
        <div class="board-view">
            <h2 style="color:var(--header-text); font-weight:900; margin-top:0;"><i class="fa-solid fa-globe"></i> ã¿ã‚“ãªã®æ„Ÿæƒ³</h2>
            <div id="global-board-list">
                </div>
        </div>
    </div>

    <div id="detail-page" class="hidden">
        <div class="detail-view">
            <button onclick="backToPrev()" style="border:none; background:var(--border); padding:10px 20px; border-radius:50px; cursor:pointer; margin-bottom:20px; font-weight:900; color: var(--text);">ğŸ”™ ã‚‚ã©ã‚‹</button>
            <h2 id="detail-title" style="color:var(--header-text); font-size: 2.2rem; margin:0 0 10px;"></h2>
            <div id="detail-date" class="date-badge" style="font-size: 1rem; margin-bottom: 10px;"></div>
            <div id="detail-info" style="margin-bottom:30px; font-size:1.1rem; font-weight:800; opacity:0.8;"></div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a id="detail-link" target="_blank" class="yt-link"><i class="fa-brands fa-youtube"></i> YouTube</a>
                <button class="full-btn" onclick="openOverlay()"><i class="fa-solid fa-expand"></i> å…¨ç”»é¢ã‚³ãƒ¡ãƒ³ãƒˆ</button>
            </div>
            <hr style="margin:40px 0; border:1px dashed var(--border);">
            <div id="comment-list"></div>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                <input type="text" id="nickname" placeholder="åå‰" style="padding:15px; border-radius:15px; border:2px solid var(--border); background:var(--card-bg); color:var(--text); font-weight: bold;">
                <textarea id="comment-text" placeholder="æ„Ÿæƒ³ã‚’æ›¸ã" style="padding:15px; border-radius:15px; border:2px solid var(--border); height:100px; background:var(--card-bg); color:var(--text); font-weight: bold;"></textarea>
                <button style="background: linear-gradient(135deg, var(--accent), var(--header-text)); color: white; border: none; padding: 18px; border-radius: 20px; font-weight: 900; cursor: pointer;" onclick="postComment()">é€ä¿¡ï¼ âœ‰ï¸</button>
            </div>
        </div>
    </div>
</div>

<div id="comment-overlay">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 id="overlay-title" style="margin: 0; font-weight: 900; color: var(--header-text);"></h2>
        <button onclick="closeOverlay()" style="background: #ff4d4d; color: white; border: none; padding: 10px 20px; border-radius: 15px; font-weight: 900; cursor: pointer;">âœ• é–‰ã˜ã‚‹</button>
    </div>
    <div id="overlay-comment-list" style="flex-grow: 1; overflow-y: auto;"></div>
    <div class="fs-post-area">
        <input type="text" id="nickname-fs" placeholder="åå‰">
        <input type="text" id="comment-text-fs" placeholder="æ„Ÿæƒ³ã‚’æ›¸ãï¼">
        <button onclick="postComment(true)" style="background: var(--header-text); color: white; border: none; padding: 0 20px; border-radius: 12px; font-weight: 900; cursor: pointer;">é€ä¿¡</button>
    </div>
</div>
<div id="thread-overlay" class="comment-overlay">
    <div class="overlay-header">
        <button class="back-btn" onclick="closeThread()"><i class="fa-solid fa-chevron-left"></i> æˆ»ã‚‹</button>
        <h2 id="thread-title" style="margin:0; font-size:1.2rem;">ã‚¹ãƒ¬ãƒƒãƒ‰</h2>
    </div>
    <div class="overlay-content">
        <div id="thread-parent-root"></div>
        <hr style="border:1px dashed var(--border); margin:20px 0;">
        <div id="thread-list"></div>
    </div>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp, updateDoc, doc, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const COMPOSER_MAP = { 
        m: "MIMI", f: "40mP", n: "ãƒŠãƒ¦ã‚¿ãƒ³æ˜Ÿäºº", k: "ã‚«ãƒ³ã‚¶ã‚­ã‚¤ã‚ªãƒª", h: "ä¸€äºŒä¸‰", i: "è™»ç€¬çŠ¬", 
        r: "ã¯ã‚‹ãªã€‚", ni: "ã«ã‚“ã˜ã‚“", t: "Twinfield", ha: "å‚˜æ‘ãƒˆãƒ¼ã‚¿", g: "Guiano", 
        to: "ã¨ã‚", a: "Aqu3ra", ao: "è‘µæœ¨ã‚´ã‚¦", na: "ãƒŠãƒ„ãƒã‚»", ch: "è¶ã€…P", 
        mi: "ã¿ãã¨P", ms: "Misumi", am: "ã‚¢ã‚µãƒãƒãƒ", ma: "è² ã‘çŠ¬", ru: "rukaku", 
        hg: "åŸå£æ²™è¼”", mf: "ã¾ãµã¾ãµ", sh: "ã‚·ãƒ£ãƒãƒ³", ai: "Aiobahn", ny: "ç…®ãƒ«æœå®Ÿ", tk:"TAKU INOUE", ot: "Other" 
    };
    const TYPE_MAP = { 0: "ã‚³ãƒ³ãƒãƒ¼ã‚¶ãƒ¼ä½œ", 1: "è‡ªä½œ", 2: "æ¥½æ›²å‚åŠ ", 3: "ã‚«ãƒãƒ¼" };

        const allSongs = [
        { t: "ä¸‰æ™‚ã®ã‚­ã‚¹", k: "ã•ã‚“ã˜ã®ãã™", c: "f", y: 0, d: 20210628, ds: "2021.06.28", v: "V-99vS_q_jI" },
        { t: "ã¾ã¡ã¼ã†ã‘", k: "ã¾ã¡ã¼ã†ã‘", c: "h", y: 0, d: 20211026, ds: "2021.10.26", v: "mB-14m_82I0" },
        { t: "ãŸã å£°ä¸€ã¤", k: "ãŸã ã“ãˆã²ã¨ã¤", c: "m", y: 0, d: 20211222, ds: "2021.12.22", v: "5L390paRE40" },
        { t: "çŸ¥ã‚‰ãªã„ã¾ã¾ã§", k: "ã—ã‚‰ãªã„ã¾ã¾ã§", c: "m", y: 0, d: 20220617, ds: "2022.06.17", v: "L_NfI9X2m2k" },
        { t: "ãƒ–ãƒªã‚¶ãƒ¼ãƒ‰", k: "ã¶ã‚Šã–ãƒ¼ã©", c: "i", y: 0, d: 20220914, ds: "2022.09.14", v: "6H0_eSjAInY" },
        { t: "æ„›ãŒç¯ã‚‹", k: "ã‚ã„ãŒã¨ã‚‚ã‚‹", c: "m", y: 0, d: 20230215, ds: "2023.02.15", v: "Vf_BskA9S4w" },
        { t: "ã°ã„ã°ã„ã¾ãŸã‚ã—ãŸ", k: "ã°ã„ã°ã„ã¾ãŸã‚ã—ãŸ", c: "r", y: 0, d: 20230419, ds: "2023.04.19", v: "4F36Y-f5i6E" },
{ t: "ã‚ã£ã¡å‘ã„ã¦æ¥ä¸–", k: "ã‚ã£ã¡ã‚€ã„ã¦ã‚‰ã„ã›", c: "r", y: 2, d: 20230509, ds: "2023.05.09", v: "4F36Y-f5i6E" },
        { t: "ã‚¹ãƒ”ã‚«", k: "ã™ã´ã‹", c: "n", y: 0, d: 20230607, ds: "2023.06.07", v: "v726K2CizX4" },
{ t: "What Call This Day?", k: "ã‚ã£ã¨ã“ãƒ¼ã‚‹ã§ãƒã™ã§ã„ï¼Ÿ", c: "m", y: 2, d: 20230712, ds: "2023.07.12", v: "v726K2CizX4" },
        { t: "å­ä¾›é¨™ã—", k: "ã“ã©ã‚‚ã ã¾ã—", c: "ny", y: 0, d: 20230823, ds: "2023.08.23", v: "fM52yP5A720" },
        { t: "çœ¼å·®ã—", k: "ã¾ãªã–ã—", c: "k", y: 0, d: 20231025, ds: "2023.10.25", v: "Gf08S1gM4tI" },
        { t: "ãƒªã‚¤ãƒ³ã‚«ãƒãƒ¼ã‚·ãƒ§ãƒ³", k: "ã‚Šã„ã‚“ã‹ã­ãƒ¼ã—ã‚‡ã‚“", c: "to", y: 0, d: 20231129, ds: "2023.11.29", v: "oF04XpX6L60" },
        { t: "æ˜Ÿå¯‚å¤œ", k: "ã›ã„ã˜ã‚ƒãã‚„", c: "a", y: 0, d: 20231229, ds: "2023.12.29", v: "6vK7y-fE0G4" },
        { t: "åƒ•ã‚‰ã®åœ¨ã‚Šå‡¦", k: "ã¼ãã‚‰ã®ã‚ã‚Šã‹", c: "ao", y: 0, d: 20231229, ds: "2023.12.29", v: "v0_V_R9_H_E" },
        { t: "é€¢ç€¬ã®ã¾ã¾ã«ã‚ãªãŸã®ã‚‚ã¨ã¸", k: "ãŠã†ã›ã®ã¾ã¾ã«ã‚ãªãŸã®ã‚‚ã¨ã¸", c: "ni", y: 1, d: 20231229, ds: "2023.12.29", v: "D3Lz_S-f80c" },
        { t: "slowly", k: "ã™ã‚ãƒ¼ã‚Šãƒ¼", c: "t", y: 0, d: 20231229, ds: "2023.12.29", v: "9YwRk1A_F_U" },
        { t: "æ°´ä»™", k: "ã™ã„ã›ã‚“", c: "ni", y: 1, d: 20231229, ds: "2023.12.29", v: "jWfGvK90S8w" },
        { t: "é´æ“¦ã‚Œ", k: "ãã¤ãšã‚Œ", c: "ni", y: 1, d: 20231229, ds: "2023.12.29", v: "" },
        { t: "ã‚ã‚„ãµã‚„", k: "ã‚ã‚„ãµã‚„", c: "m", y: 0, d: 20240207, ds: "2024.02.07", v: "Fm6869vM70E" },
        { t: "ãƒ¦ãƒªã‚¤ã‚«", k: "ã‚†ã‚Šã„ã‹", c: "ha", y: 0, d: 20240402, ds: "2024.04.02", v: "f_X3m_G8_Dk" },
        { t: "About you", k: "ã‚ã°ã†ã¨ã‚†ãƒ¼", c: "g", y: 0, d: 20240619, ds: "2024.06.19", v: "mX-k3O9H2V0" },
        { t: "å¤œæ˜ã‘ã¨è›", k: "ã‚ˆã‚ã‘ã¨ã»ãŸã‚‹", c: "ot", y: 3, d: 20240619, ds: "2024.06.19", v: "" },
        { t: "ã‚¢ãƒ«ãƒ“ãƒ¬ã‚ª", k: "ã‚ã‚‹ã³ã‚ŒãŠ", c: "n", y: 0, d: 20240904, ds: "2024.09.04", v: "47k-qG_Y_50" },
        { t: "è‰ã€…ä¸ä¸€", k: "ãã†ãã†ãµã„ã¤", c: "k", y: 0, d: 20241104, ds: "2024.11.04", v: "v_7G4Xm6I8V" },
        { t: "è¨€ã®åˆƒ", k: "ã“ã¨ã®ã¯", c: "h", y: 0, d: 20250108, ds: "2025.01.08", v: "" },
        { t: "å¿ƒã®å¥¥", k: "ã“ã“ã‚ã®ãŠã", c: "m", y: 0, d: 20250205, ds: "2025.02.05", v: "" },
        { t: "èŠ±æ³¡æ²«", k: "ã¯ãªã†ãŸã‹ãŸ", c: "na", y: 0, d: 20250205, ds: "2025.02.05", v: "" },
        { t: "æµæ˜Ÿã®å£°", k: "ã‚Šã‚…ã†ã›ã„ã®ã“ãˆ", c: "ch", y: 0, d: 20250205, ds: "2025.02.05", v: "" },
        { t: "è„ˆæ‹", k: "ã¿ã‚ƒãã¯ã", c: "mi", y: 0, d: 20250507, ds: "2025.05.07", v: "" },
{ t: "ãƒˆãƒ©ãƒ•", k: "ã¨ã‚‰ãµ", c: "tk", y: 2, d: 20250624, ds: "2025.06.24", v: "" },
        { t: "é›¨æ™¯è‰²", k: "ã‚ã‚ã’ã—ã", c: "ms", y: 0, d: 20250723, ds: "2025.07.23", v: "" },
        { t: "æ¯ç¶™ã", k: "ã„ãã¤ã", c: "am", y: 0, d: 20250723, ds: "2025.07.23", v: "" },
        { t: "å¤ã‚’æ›¸ãç•™ã‚ã‚‹", k: "ãªã¤ã‚’ã‹ãã¨ã‚ã‚‹", c: "ma", y: 0, d: 20250723, ds: "2025.07.23", v: "" },
        { t: "æ²ã¿è¾¼ã‚€", k: "ã—ã¿ã“ã‚€", c: "ru", y: 0, d: 20250723, ds: "2025.07.23", v: "" },
        { t: "é å¿ƒåŠ›", k: "ãˆã‚“ã—ã‚“ã‚Šã‚‡ã", c: "hg", y: 0, d: 20250723, ds: "2025.07.23", v: "" },
        { t: "ã‚¤ã‚ª", k: "ã„ãŠ", c: "n", y: 0, d: 20250827, ds: "2025.08.27", v: "" },
        { t: "ã‚«ãƒ­ãƒ³", k: "ã‹ã‚ã‚“", c: "n", y: 0, d: 20251022, ds: "2025.10.22", v: "" },
        { t: "é¯¨ã®è½ã¡ã‚‹è¡—", k: "ãã˜ã‚‰ã®ãŠã¡ã‚‹ã¾ã¡", c: "mf", y: 0, d: 20251224, ds: "2025.12.24", v: "" },
        { t: "Happines Umbrella", k: "ã¯ã´ã­ã™ã‚ã‚“ã¶ã‚Œã‚‰", c: "mi", y: 0, d: 20251224, ds: "2025.12.24", v: "" },
        { t: "çœ©ã—ã™ããŸæœ", k: "ã¾ã¶ã—ã™ããŸã‚ã•", c: "ni", y: 1, d: 20251224, ds: "2025.12.24", v: "" },
        { t: "ã‚¨ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ«", k: "ãˆã‚“ã©ã‚ãƒ¼ã‚‹", c: "ms", y: 0, d: 20251224, ds: "2025.12.24", v: "" },
        { t: "ãƒªãƒ—ãƒ¬ã‚¤", k: "ã‚Šã·ã‚Œã„", c: "sh", y: 0, d: 20251224, ds: "2025.12.24", v: "" },
        { t: "ç…©æ‚©", k: "ã¼ã‚“ã®ã†", c: ["ai", "r"], y: 0, d: 20251224, ds: "2025.12.24", v: "f-r60yR6388" },
        { t: "ç”Ÿæ´»ã®", k: "ã›ã„ã‹ã¤ã®", c: "k", y: 0, d: 20260204, ds: "2026.02.04", v: "" }
    ];


    const firebaseConfig = { apiKey: "AIzaSyA4RkG6F8HSp3zsMQofEdCrfnuvHA4_duY", authDomain: "oshipedia.firebaseapp.com", projectId: "oshipedia", storageBucket: "oshipedia.firebasestorage.app", messagingSenderId: "242921301200", appId: "1:242921301200:web:f67d57a13dfde3af132ad5" };
    const db = getFirestore(initializeApp(firebaseConfig));

    let activeFilters = { c: [], y: [], fav: [] };
    let favorites = JSON.parse(localStorage.getItem('rokudenashi_favs')) || [];
    let unsubscribeDetail = null;
    let currentSongTitle = "";
    let currentTab = "songs";
    let replyTargetId = null; 
    // ã‚¹ãƒ¬ãƒƒãƒ‰è¡¨ç¤ºç”¨ã®è³¼èª­è§£é™¤å¤‰æ•°
    let unsubscribeThread = null;

    // ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹ã
    window.openThread = async (parentId) => {
        const overlay = document.getElementById('thread-overlay');
        const parentRoot = document.getElementById('thread-parent-root');
        const threadList = document.getElementById('thread-list');
        
        overlay.classList.add('active');
        threadList.innerHTML = "<p style='text-align:center;'>èª­ã¿è¾¼ã¿ä¸­...</p>";

        // 1. è¦ªã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€åº¦ã ã‘å–å¾—ã—ã¦è¡¨ç¤º
        try {
            const parentDoc = await getDocs(query(collection(db, "comments"), where("__name__", "==", parentId)));
            if (!parentDoc.empty) {
                const pd = parentDoc.docs[0].data();
                parentRoot.innerHTML = `
                    <div class="comment-item" style="background:var(--card-bg); padding:15px; border-radius:15px; border:2px solid var(--border); font-weight:700;">
                        <b>${pd.name}</b><br>
                        <p style="margin:10px 0;">${pd.text}</p>
                        <button class="action-btn" onclick="openReplyMode('${parentId}', '${pd.name}'); closeThread();">
                            <i class="fa-solid fa-reply"></i> ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«è¿”ä¿¡ã™ã‚‹
                        </button>
                    </div>`;
            }
        } catch (e) { console.error(e); }

        // 2. ãã®è¦ªIDã‚’æŒã¤è¿”ä¿¡ã™ã¹ã¦ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—
        const q = query(collection(db, "comments"), 
                        where("parentId", "==", parentId), 
                        orderBy("timestamp", "asc"));

        if (unsubscribeThread) unsubscribeThread();
        unsubscribeThread = onSnapshot(q, sn => {
            threadList.innerHTML = sn.empty ? "<p style='text-align:center; opacity:0.6;'>ã¾ã è¿”ä¿¡ã¯ã‚ã‚Šã¾ã›ã‚“</p>" : "";
            sn.forEach(docSnap => {
                const rd = docSnap.data();
                const rid = docSnap.id;
                const html = `
                    <div class="comment-item reply-item" style="background:var(--bg); padding:12px; border-radius:12px; margin-bottom:10px; border:1px solid var(--border); font-weight:700;">
                        <b>${rd.name}</b><br>
                        <p style="margin:5px 0; font-size:0.95rem;">${rd.text}</p>
                        <div class="comment-actions">
                            <button class="action-btn ${localStorage.getItem('liked_'+rid)?'liked':''}" onclick="toggleCommentLike('${rid}')">
                                <i class="fa-solid fa-heart"></i> ${rd.likes || 0}
                            </button>
                        </div>
                    </div>`;
                threadList.insertAdjacentHTML('beforeend', html);
            });
        });
    };

    // ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‰ã˜ã‚‹
    window.closeThread = () => {
        document.getElementById('thread-overlay').classList.remove('active');
        if (unsubscribeThread) {
            unsubscribeThread();
            unsubscribeThread = null;
        }
    };


    window.init = () => {
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark');
            document.getElementById('theme-icon').className = 'fa-solid fa-sun';
        }
        setupFilters();
        loadGlobalBoard();
        search();
    };

    // --- UI Helpers ---
    window.switchTab = (tab) => {
        currentTab = tab;
        document.getElementById('btn-songs').classList.toggle('active', tab === 'songs');
        document.getElementById('btn-board').classList.toggle('active', tab === 'board');
        document.getElementById('tab-content-songs').classList.toggle('hidden', tab !== 'songs');
        document.getElementById('tab-content-board').classList.toggle('hidden', tab !== 'board');
        document.getElementById('detail-page').classList.add('hidden');
    };

    window.toggleTheme = () => {
        const isDark = document.body.classList.toggle('dark');
        document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };

    window.toggleFilter = () => {
        const content = document.getElementById('filter-content');
        const icon = document.getElementById('filter-icon');
        content.classList.toggle('collapsed');
        icon.className = content.classList.contains('collapsed') ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-up';
    };

    // --- Filtering ---
    function setupFilters() {
        const filterHtml = `
            <div class="filter-group"><span class="filter-label"><i class="fa-solid fa-heart"></i> FAVORITE</span>
                <div class="tag-container"><button class="tag-btn-filter active" onclick="updateFilter(this, 'fav', 'all')">ã™ã¹ã¦</button><button class="tag-btn-filter" onclick="updateFilter(this, 'fav', 'only')">ãŠæ°—ã«å…¥ã‚Šæ¸ˆã¿</button></div>
            </div>
            <div class="filter-group"><span class="filter-label"><i class="fa-solid fa-palette"></i> COMPOSER</span>
                <div class="tag-container"><button class="tag-btn-filter active" onclick="updateFilter(this, 'c', 'all')">ã™ã¹ã¦</button>${Object.entries(COMPOSER_MAP).map(([id, name]) => `<button class="tag-btn-filter" onclick="updateFilter(this, 'c', '${id}')">${name}</button>`).join('')}</div>
            </div>
            <div class="filter-group"><span class="filter-label"><i class="fa-solid fa-guitar"></i> TYPE</span>
                <div class="tag-container"><button class="tag-btn-filter active" onclick="updateFilter(this, 'y', 'all')">ã™ã¹ã¦</button>${Object.entries(TYPE_MAP).map(([id, name]) => `<button class="tag-btn-filter" onclick="updateFilter(this, 'y', ${id})">${name}</button>`).join('')}</div>
            </div>`;
        document.getElementById('filter-content').innerHTML = filterHtml;
    }

    window.updateFilter = (btn, key, val) => {
        if (val === 'all') { activeFilters[key] = []; btn.parentElement.querySelectorAll('.tag-btn-filter').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        else { btn.parentElement.querySelector('button').classList.remove('active'); btn.classList.toggle('active'); if (activeFilters[key].includes(val)) activeFilters[key] = activeFilters[key].filter(v => v !== val); else activeFilters[key].push(val); if (activeFilters[key].length === 0) btn.parentElement.querySelector('button').classList.add('active'); }
        search();
    };

            window.search = () => {
        const word = (document.getElementById('search-box').value || "").toLowerCase();
        const sortVal = document.getElementById('sort-order').value;
        
        let filtered = allSongs.filter(s => {
            const matchesWord = s.t.toLowerCase().includes(word) || (s.k && s.k.includes(word));
            const songComps = Array.isArray(s.c) ? s.c : [s.c];
            const matchesComp = activeFilters.c.length === 0 || songComps.some(id => activeFilters.c.includes(id));
            const matchesType = activeFilters.y.length === 0 || activeFilters.y.includes(s.y);
            const matchesFav = activeFilters.fav.length === 0 || favorites.includes(s.t);
            return matchesWord && matchesComp && matchesType && matchesFav;
        });

        // --- ã€è¿½åŠ ã€‘ä»¶æ•°è¡¨ç¤ºã®æ›´æ–° ---
        const countEl = document.getElementById('result-count');
        const isFiltering = word !== "" || activeFilters.c.length > 0 || activeFilters.y.length > 0 || activeFilters.fav.length > 0;
        
        if (isFiltering) {
            countEl.innerText = `${filtered.length} ä»¶ãƒ’ãƒƒãƒˆã—ã¾ã—ãŸ`;
        } else {
            countEl.innerText = `å…¨ ${filtered.length} æ›²`;
        }
        // ----------------------------

        // ã‚½ãƒ¼ãƒˆå‡¦ç†ï¼ˆå‰å›ã®ã²ã‚‰ãŒãªå¯¾å¿œç‰ˆï¼‰
        filtered.sort((a, b) => {
            if (sortVal === 'date-desc') return b.d - a.d;
            if (sortVal === 'date-asc') return a.d - b.d;
            if (sortVal === 'kana-asc') return a.k.localeCompare(b.k, 'ja');
            return 0;
        });

        // ãƒªã‚¹ãƒˆã®æç”»ï¼ˆæ—¢å­˜ã®å‡¦ç†ï¼‰
        document.getElementById('song-list').innerHTML = filtered.map(s => `
            <div class="song-card" onclick="showDetailPage('${s.t}')">
                <button class="fav-btn ${favorites.includes(s.t) ? 'active' : ''}" onclick="event.stopPropagation(); toggleFav('${s.t}')"><i class="fa-solid fa-heart"></i></button>
                <div class="date-badge">${s.ds}</div>
                <b>${s.t}</b>
                <div class="card-tags">
                    <span class="mini-tag"><i class="fa-solid fa-palette"></i> ${(Array.isArray(s.c)?s.c:[s.c]).map(id=>COMPOSER_MAP[id]).join(', ')}</span>
                    <span class="mini-tag y"><i class="fa-solid fa-guitar"></i> ${TYPE_MAP[s.y]}</span>
                </div>
            </div>`).join('');
    };



    window.toggleFav = (title) => {
        favorites = favorites.includes(title) ? favorites.filter(t => t !== title) : [...favorites, title];
        localStorage.setItem('rokudenashi_favs', JSON.stringify(favorites));
        search();
    };

    // --- Board & Comments ---
        function loadGlobalBoard() {
        // ä¿®æ­£ï¼šwhere("parentId", "==", null) ã‚’å‰Šé™¤ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’å›é¿
        const q = query(
            collection(db, "comments"), 
            orderBy("timestamp", "desc"), 
            limit(50) // å°‘ã—å¤šã‚ã«å–å¾—ã—ã¦ã€å¾Œã§è¦ªã‚³ãƒ¡ãƒ³ãƒˆã ã‘ã«çµã‚Šè¾¼ã‚€
        );

        onSnapshot(q, sn => {
            const list = document.getElementById('global-board-list');
            list.innerHTML = "";
            let count = 0;

            sn.forEach(docSnap => {
                const d = docSnap.data();
                
                // è¦ªã‚³ãƒ¡ãƒ³ãƒˆï¼ˆparentIdãŒãªã„ã‚‚ã®ï¼‰ã ã‘ã‚’è¡¨ç¤ºã—ã€æœ€å¤§20ä»¶ã¾ã§
                if (d.parentId || count >= 20) return; 

                count++;
                const item = document.createElement('div');
                item.className = 'board-item';
                item.onclick = () => showDetailPage(d.song);
                item.innerHTML = `
                    <b>${d.name}</b>
                    <span class="target-song">${d.song}</span>
                    <br>
                    <p style="margin:10px 0 0; font-weight:700;">${d.text}</p>
                `;
                list.appendChild(item);
            });

            if (count === 0) {
                list.innerHTML = "<p style='text-align:center;'>ã¾ã æ„Ÿæƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
            }
        });
    }


    window.showDetailPage = (title) => {
        currentSongTitle = title; const s = allSongs.find(x => x.t === title); if (!s) return;
        document.getElementById('detail-title').innerText = s.t;
        document.getElementById('overlay-title').innerText = `ğŸ’¬ ${s.t}`;
        document.getElementById('detail-date').innerText = `Release: ${s.ds}`;
        document.getElementById('detail-info').innerText = `${(Array.isArray(s.c)?s.c:[s.c]).map(id=>COMPOSER_MAP[id]).join(', ')} / ${TYPE_MAP[s.y]}`;
        document.getElementById('detail-link').href = s.v ? `https://www.youtube.com/watch?v=${s.v}` : `https://www.youtube.com/results?search_query=ãƒ­ã‚¯ãƒ‡ãƒŠã‚·+${s.t}`;
        
        document.getElementById('tab-content-songs').classList.add('hidden');
        document.getElementById('tab-content-board').classList.add('hidden');
        document.getElementById('detail-page').classList.remove('hidden');
        window.scrollTo(0,0);
        loadDetailComments(title);
    };

    window.backToPrev = () => switchTab(currentTab);
    window.openOverlay = () => document.getElementById('comment-overlay').classList.add('active');
    window.closeOverlay = () => document.getElementById('comment-overlay').classList.remove('active');

    // ã„ã„ã­æ©Ÿèƒ½
    window.toggleCommentLike = async (commentId) => {
        const commentRef = doc(db, "comments", commentId);
        const likedKey = `liked_${commentId}`;
        if (localStorage.getItem(likedKey)) {
            await updateDoc(commentRef, { likes: increment(-1) });
            localStorage.removeItem(likedKey);
        } else {
            await updateDoc(commentRef, { likes: increment(1) });
            localStorage.setItem(likedKey, "true");
        }
    };

    // è¿”ä¿¡ãƒ¢ãƒ¼ãƒ‰
    window.openReplyMode = (commentId, name) => {
        replyTargetId = commentId;
        const input = document.getElementById('comment-text');
        input.value = `@${name} `;
        input.focus();
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

        async function loadDetailComments(t) {
        const list = document.getElementById('comment-list');
        const oList = document.getElementById('overlay-comment-list');
        
        // ä¿®æ­£ï¼šwhereã‚’ä¸€ã¤ã«ã—ã¦ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ï¼
        const q = query(
            collection(db, "comments"), 
            where("song", "==", t), 
            orderBy("timestamp", "desc")
        );
        
        if(unsubscribeDetail) unsubscribeDetail();

        unsubscribeDetail = onSnapshot(q, (sn) => {
            list.innerHTML = "";
            let hasParent = false;

            sn.forEach(docSnap => {
                const d = docSnap.data();
                const id = docSnap.id;
                
                // è¦ªã‚³ãƒ¡ãƒ³ãƒˆï¼ˆparentIdãŒãªã„ã‚‚ã®ï¼‰ã ã‘ã‚’è¡¨ç¤ºå¯¾è±¡ã«ã™ã‚‹
                if (d.parentId) return; 

                hasParent = true;
                const threadBtn = (d.replyCount > 0) 
                    ? `<button class="view-thread-btn" onclick="openThread('${id}')">
                        <i class="fa-solid fa-comments"></i> è¿”ä¿¡ã‚’è¡¨ç¤º (${d.replyCount}ä»¶)
                       </button>` 
                    : "";

                const commentHtml = `
                    <div class="comment-item" style="background:var(--card-bg); padding:15px; border-radius:15px; margin-bottom:12px; border:2px solid var(--border); font-weight:700;">
                        <b>${d.name}</b><br>
                        <p style="margin:10px 0;">${d.text}</p>
                        <div class="comment-actions">
                            <button class="action-btn ${localStorage.getItem('liked_'+id)?'liked':''}" onclick="toggleCommentLike('${id}')">
                                <i class="fa-solid fa-heart"></i> ${d.likes || 0}
                            </button>
                            <button class="action-btn" onclick="openReplyMode('${id}', '${d.name}')">
                                <i class="fa-solid fa-reply"></i> è¿”ä¿¡
                            </button>
                        </div>
                        ${threadBtn}
                    </div>`;
                
                list.insertAdjacentHTML('beforeend', commentHtml);
            });

            if(!hasParent) {
                list.innerHTML = "<p style='text-align:center;'>æ„Ÿæƒ³å‹Ÿé›†ä¸­ï¼</p>";
            }
            oList.innerHTML = list.innerHTML;
        });
    }



    window.postComment = async (fs = false) => {
        const nId = fs ? 'nickname-fs' : 'nickname';
        const tId = fs ? 'comment-text-fs' : 'comment-text';
        const n = document.getElementById(nId).value;
        const t = document.getElementById(tId).value;
        if (!n || !t) return;

        const commentData = {
            song: currentSongTitle,
            name: n,
            text: t,
            timestamp: serverTimestamp(),
            likes: 0,
            replyCount: 0,
            parentId: replyTargetId || null
        };

        const newDoc = await addDoc(collection(db, "comments"), commentData);
        
        // è¿”ä¿¡ã®å ´åˆã€è¦ªã®ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™
        if (replyTargetId) {
            await updateDoc(doc(db, "comments", replyTargetId), {
                replyCount: increment(1)
            });
        }

        document.getElementById(nId).value = ""; 
        document.getElementById(tId).value = "";
        replyTargetId = null; 
    };

    window.onload = () =>{window.init()}
</script>




</body>
</html>
